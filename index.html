<!DOCTYPE html>
<html>
<head>
    <title>Premier !!</title>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div id="menu-container" class="transformBackIn">
    <div class="radio-group" id="radio-selectGroup">
        <input type="radio" id="option-select" name="selector" checked="checked" value="select"><label for="option-select"><i id="option-select-icon" class="material-icons md-dark md-inactive">how_to_reg</i></label><input type="radio" id="option-group" name="selector" value="teams"><label for="option-group"><i id="option-group-icon" class="material-icons md-dark md-inactive">group</i></label><input type="radio" id="option-ordinate" name="selector" value="ordinate"><label for="option-ordinate"><i id="option-ordinate-icon"class="material-icons md-dark md-inactive">signal_cellular_alt</i></label>
    </div>
    <div id="toggle-vibration-container">
            <i id="toggle-vibration" class="material-icons md-inactive">vibration</i>
    </div>
    <div class="radio-group" id="radio-selectNumber">
        <input type="radio" id="number-1" name="number" checked="checked" value="1"><label for="number-1" id="label-number1">1</label><input type="radio" id="number-2" name="number" value="2"><label for="number-2">2</label><input type="radio" id="number-3" name="number" value="3"><label for="number-3">3</label><input type="radio" id="number-4" name="number" value="4"><label for="number-4">4</label><input type="radio" id="number-5" name="number" value="5"><label for="number-5">5</label>
    </div>

</div>
<div id="mainContainer"></div>

<script type="text/javascript">
let timerTrigger = -1;
let resetAllTimeout = -1;
let vibrate = false;
const triggerTimeout = 2500;
const defaultColours = ['#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99','#b15928'];
let colour = [];
const container = document.getElementById("mainContainer");
const touches = document.getElementsByClassName("touch");

const showSelect = () => {
    document.getElementById("label-number1").style.display = "";
    document.getElementById("label-number1").style.visibility = "";
    document.getElementById("radio-selectNumber").style.display = "";
    document.getElementById("radio-selectNumber").style.visibility = "";
    document.getElementById("option-select-icon").classList.remove("md-inactive");
    document.getElementById("option-group-icon").classList.add("md-inactive");
    document.getElementById("option-ordinate-icon").classList.add("md-inactive");
};

const showGroup = () => {
    document.getElementById("label-number1").style.display = "none";
    document.getElementById("label-number1").style.visibility = "hidden";
    document.getElementById("radio-selectNumber").style.display = "";
    document.getElementById("radio-selectNumber").style.visibility = "";
    if (document.getElementById("number-1").checked) {
        document.getElementById("number-2").checked = true;
    }
    document.getElementById("option-select-icon").classList.add("md-inactive");
    document.getElementById("option-group-icon").classList.remove("md-inactive");
    document.getElementById("option-ordinate-icon").classList.add("md-inactive");
};

const showOrdinate = () => {
    document.getElementById("radio-selectNumber").style.display = "none";
    document.getElementById("radio-selectNumber").style.visibility = "hidden";

    document.getElementById("option-select-icon").classList.add("md-inactive");
    document.getElementById("option-group-icon").classList.add("md-inactive");
    document.getElementById("option-ordinate-icon").classList.remove("md-inactive");
};
// Properly initialise the radio buttons
if (document.getElementById("option-select").checked) {
    showSelect();
}
else if (document.getElementById("option-group").checked) {
    showGroup();
}
else { //option-ordinate
    showOrdinate();
}

// set the events on the radio buttons
document.getElementById("option-select").addEventListener("change", () => showSelect());
document.getElementById("option-group").addEventListener("change", () => showGroup());
document.getElementById("option-ordinate").addEventListener("change", () => showOrdinate());

// toggling the vibration
document.getElementById("toggle-vibration").addEventListener("click", (e) => {
    e.target.classList.toggle("md-inactive");
    vibrate = !vibrate;
    if(vibrate) {
        window.navigator.vibrate(50);
    }
});

const getRandomColour = () => colour.splice(Math.floor(Math.random() * colour.length), 1)[0];

const getNoTeamColour = () => '#C0C0C0'; // you go Glen

const getRadioValue = id => Number(document.querySelector(`input[name="${id}"]:checked`).value);

const getRandom = (touchList, n) => {
    let result = new Array(n);
    let touchListLen = touchList.length;
    let taken = new Array(touchListLen);
    if (n > touchListLen) {
        throw new RangeError("getRandom: more elements taken than available");
    }
    while (n--) {
        const x = Math.floor(Math.random() * touchListLen);
        result[n] = touchList[x in taken ? taken[x] : x];
        taken[x] = --touchListLen in taken ? taken[touchListLen] : touchListLen;
    }
    return result;
};

const selectPlayers = (numberToSelect) => {
    const playerList = [...touches].map(t => t.id);
    const selectedTouches = getRandom(playerList, numberToSelect);

    for (let i=0; i < selectedTouches.length; ++i) {
        const element = document.getElementById(selectedTouches[i]);
        if (element) {
            element.classList.add("selectedTouch");
        }
    }

    document.querySelectorAll(".touch:not(.selectedTouch)").forEach(t => {
        t.parentNode.removeChild(t);
    });
};

const selectTeams = (numberOfTeams) => {
    const splitIntoTeams = (touches, numberOfTeams) => {
        const touchCount = touches.length;
        const teamArray = [];
        let i = 0;
        if (touchCount % numberOfTeams === 0) {
            const size = Math.floor(touchCount / numberOfTeams);
            while (i < touchCount) {
                teamArray.push(touches.slice(i, i += size));
            }
        }
        else {
            while (i < touchCount) {
                const size = Math.ceil((touchCount - i) / numberOfTeams--);
                teamArray.push(touches.slice(i, i += size));
            }
        }
        return teamArray;
    };
    const playerList = [...touches].map(t => t.id);
    if (numberOfTeams > playerList.length) {
        throw new RangeError("selectTeams: more elements taken than available");
    }
    const randomisedTouches = getRandom(playerList, playerList.length);
    const splitTeams = splitIntoTeams(randomisedTouches, numberOfTeams);
    for (let i=0; i < splitTeams.length; ++i) {
        const teamColour = getRandomColour();
        for (let j=0; j < splitTeams[i].length; ++j) {
            const e = document.getElementById(splitTeams[i][j]);
            if (e) {
                e.style.background = teamColour;
                e.classList.add("selectedTouch");
            }
        }
    }
};

const selectNumbers = () => {
    const playerList = [...touches].map(t => t.id);
    const randomisedTouches = getRandom(playerList, playerList.length);
    for (let i = 0; i < randomisedTouches.length; ++i) {
        const e = document.getElementById(randomisedTouches[i]);
        if (e) {
            e.classList.add("selectedTouch");
            const s = e.getElementsByTagName("span")[0];
            if (s) {
                s.innerHTML = i + 1;
            }
        }
    }
};

const resetAll = () => {
    colour = defaultColours.slice();
    showMenu();
    [...touches].forEach(t => {
        t.parentNode.removeChild(t);
    });
    clearTimeout(timerTrigger);
    clearTimeout(resetAllTimeout);

    container.removeEventListener("touchstart", ignoreEvent);
    container.removeEventListener("touchmove", ignoreEvent);
    container.removeEventListener("touchend", ignoreEvent);
    container.removeEventListener("touchend", handleFinishTouchEnd);

    container.addEventListener("touchstart", handleNewTouch);
    container.addEventListener("touchmove", handleTouchMove);
    container.addEventListener("touchend", handleTouchEnd);
};

const triggerSelection = () => {
    clearTimeout(timerTrigger);

    const numbersSelected = getRadioValue("number");
    switch (getFeatureType()) {
        case featureTypes.select :
            selectPlayers(numbersSelected);
            break;
        case featureTypes.teams :
            selectTeams(numbersSelected);
            break;
        case featureTypes.ordinate :
            selectNumbers();
            break;
        default:
            throw new Error("Unrecognised feature type.");
    }

    if (vibrate) {
        window.navigator.vibrate([50, 10, 50]);
    }

    container.removeEventListener("touchstart", handleNewTouch);
    container.addEventListener("touchstart", ignoreEvent);
    container.removeEventListener("touchend", handleTouchEnd);
    container.addEventListener("touchend", handleFinishTouchEnd);
};

const hideMenu = () => {
    document.getElementById("menu-container").classList.add("transformAway");
    document.getElementById("menu-container").classList.remove("transformBackIn");
};
const showMenu = () => {
    document.getElementById("menu-container").classList.remove("transformAway");
    document.getElementById("menu-container").classList.add("transformBackIn");
};

const handleNewTouch = ev => {
    hideMenu();
    const changedTouches = ev.changedTouches;
    for (let i=0; i < changedTouches.length; ++i) {
        const newTouch = document.createElement("div");
        const span = document.createElement("span");
        newTouch.classList.add("touch");
        newTouch.id = `touch-${changedTouches[i].identifier}`;
        const touchColour = getFeatureType() == featureTypes.teams ? getNoTeamColour() : getRandomColour();
        newTouch.style.background = touchColour;
        newTouch.style.color = touchColour;
        newTouch.style.top = `${changedTouches[i].pageY}px`;
        newTouch.style.left = `${changedTouches[i].pageX}px`;
        newTouch.appendChild(span);
        document.getElementById("mainContainer").appendChild(newTouch);
    }
    resetTimerTrigger();
};

const resetTimerTrigger = () => {
    const feature = getFeatureType();
    clearTimeout(timerTrigger);
    if (
        (feature == featureTypes.select && touches.length > getRadioValue("number")) ||
        (feature == featureTypes.teams && touches.length >= getRadioValue("number")) ||
         feature == featureTypes.ordinate
    ) {
        timerTrigger = setTimeout(triggerSelection, triggerTimeout);
    }
};

const featureTypes = Object.freeze({
    select: 1,
    teams: 2,
    ordinate: 3
});

const getFeatureType = () => {
    switch (document.querySelector('input[name="selector"]:checked').value) {
        case 'select':
            return featureTypes.select;
        case 'teams':
            return featureTypes.teams;
        case 'ordinate':
            return featureTypes.ordinate;
        default:
            throw new Error("Unrecognised feature type.");
    }
};

const handleTouchMove = ev => {
    eventHandler(ev);
};

const ignoreEvent = ev => {
    ev.preventDefault();
};

const handleTouchEnd = ev => {
    eventHandler(ev);
};

const handleFinishTouchEnd = ev => {
    eventHandler(ev, true);
};

const eventHandler = (ev, finish = false) => {
    ev.preventDefault();
    const changedTouches = ev.changedTouches;
    for (let i=0; i < changedTouches.length; ++i) {
        const element = document.getElementById(`touch-${changedTouches[i].identifier}`);
        if (element) {
            switch (ev.type) {
                case "touchmove":
                    if (!element.classList.contains("locked")) {
                        element.style.top = `${changedTouches[i].pageY}px`;
                        element.style.left = `${changedTouches[i].pageX}px`;
                    }
                    break;
                case "touchend":
                    if (!finish) {
                        if (getFeatureType() != featureTypes.teams) {
                            colour.push(element.style.backgroundColor);
                        }
                        element.parentNode.removeChild(element);
                        resetTimerTrigger();
                    }
                    else {
                        element.classList.add("locked");
                        if (document.querySelectorAll(".touch:not(.locked)").length == 0) {
                            resetAllTimeout = setTimeout(resetAll, triggerTimeout);
                        }
                    }
                    break;
                default:
                    throw new Error("Unrecognised event type.");
            }
        }
    }

    if (ev.type == "touchend" && touches.length == 0) {
        showMenu();
    }
};

resetAll();

</script>
</body>
</html>
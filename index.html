<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <title>Choose!</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="prefetch" href="./img/fullscreen-checked.svg" />
        <link rel="prefetch" href="./img/fullscreen-unchecked.svg" />
        <link rel="prefetch" href="./img/group-checked.svg" />
        <link rel="prefetch" href="./img/group-unchecked.svg" />
        <link rel="prefetch" href="./img/help-checked.svg" />
        <link rel="prefetch" href="./img/help-unchecked.svg" />
        <link rel="prefetch" href="./img/ordinate-checked.svg" />
        <link rel="prefetch" href="./img/ordinate-unchecked.svg" />
        <link rel="prefetch" href="./img/select-checked.svg" />
        <link rel="prefetch" href="./img/select-unchecked.svg" />
        <link rel="prefetch" href="./img/vibration-checked.svg" />
        <link rel="prefetch" href="./img/vibration-unchecked.svg" />
        <script src="playerTouch.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <canvas id="canvas">shit.</canvas>
        <div id="menuContainer" class="transformBackIn">
            <div class="radio-group" id="radio-selectGroup">
                <input type="radio" id="option-select" name="selector" checked="checked" value="select"><label for="option-select"></label>
                <input type="radio" id="option-group" name="selector" value="teams"><label for="option-group"></label>
                <input type="radio" id="option-ordinate" name="selector" value="ordinate"><label for="option-ordinate"></label>
            </div>
            <div class="radio-group" id="radio-selectNumber">
                <input type="radio" id="number-1" name="number" checked="checked" value="1"><label for="number-1" id="label-number1">1</label>
                <input type="radio" id="number-2" name="number" value="2"><label for="number-2">2</label>
                <input type="radio" id="number-3" name="number" value="3"><label for="number-3">3</label>
                <input type="radio" id="number-4" name="number" value="4"><label for="number-4">4</label>
                <input type="radio" id="number-5" name="number" value="5"><label for="number-5">5</label>
            </div>
        </div>
        <div id="helpContainerWrapper">
            <div id="helpContainer">
                <dl>
                    <dt>
                        <i class="material-icons">how_to_reg</i>
                    </dt>
                    <dd>
                        <ol>
                            <li>Chose the number of people to be selected</li>
                            <li>Have everyone touch the screen</li>
                            <li>The selected people will be highlighted</li>
                        </ol>
                    </dd>
                    <dt>
                        <i class="material-icons">group</i></dt>
                    <dd>
                        <ol>
                            <li>Chose a number of teams</li>
                            <li>Have everyone touch the screen</li>
                            <li>People will be split into teams</li>
                        </ol>
                    </dd>
                    <dt>
                        <i class="material-icons">signal_cellular_alt</i></dt>
                    <dd>
                        <ol>
                            <li>Have everyone touch the screen</li>
                            <li>People will be given a starting number</li>
                        </ol>
                    </dd>
                    <dt>
                        <i class="material-icons">vibration</i>
                    </dt>
                    <dd>
                        Toggle the vibration
                    </dd>
                    <dt>
                        <i class="material-icons">help</i>
                    </dt>
                    <dd>
                        Open this message
                    </dd>
                    <dt>
                        <i class="material-icons">fullscreen</i>
                    </dt>
                    <dd>
                        Toggle fullscreen
                    </dd>
                </dl>
            </div>
        </div>
        <div id="footerContainer">
            <div id="footerGrid" class="transformBackIn">
                <img src="./img/vibration-unchecked.svg">
                <img src="./img/help.svg">
                <img src="./img/fullscreen-unchecked.svg">
            </div>
        </div>
        <script>
const helpContainer = document.getElementById("helpContainerWrapper");
const labelNumber1 = document.getElementById("label-number1");
const radioSelectNumber = document.getElementById("radio-selectNumber");
const optionSelect = document.getElementById("option-select");

const showSelect = () => {
    labelNumber1.style.display = "";
    labelNumber1.style.visibility = "";
    radioSelectNumber.style.display = "";
    radioSelectNumber.style.visibility = "";
};

const showGroup = () => {
    labelNumber1.style.display = "none";
    labelNumber1.style.visibility = "hidden";
    radioSelectNumber.style.display = "";
    radioSelectNumber.style.visibility = "";
    if (document.getElementById("number-1").checked) {
        document.getElementById("number-2").checked = true;
    }
};

const showOrdinate = () => {
    radioSelectNumber.style.display = "none";
    radioSelectNumber.style.visibility = "hidden";
};

const getRadioValue = id => Number(document.querySelector(`input[name="${id}"]:checked`).value);
const menuContainer = document.getElementById("menuContainer");
const footerContainer = document.getElementById("footerContainer");
const canvas = document.getElementById("canvas");
const touchList = new TouchList(canvas);

let timerTrigger = -1;
const triggerTimeout = 2500;
const displayTimeout = 1500;
       
const featureTypes = Object.freeze({
    select: 1,
    teams: 2,
    ordinate: 3
});

const getFeatureType = () => {
    switch (document.querySelector('input[name="selector"]:checked').value) {
        case 'select':
            return featureTypes.select;
        case 'teams':
            return featureTypes.teams;
        case 'ordinate':
            return featureTypes.ordinate;
        default:
            throw new Error("Unrecognised feature type.");
    }
};

const resetTimerTrigger = () => {
    const feature = getFeatureType();
    clearTimeout(timerTrigger);
    if (
        (feature == featureTypes.select && touchList.touchesLength() > getRadioValue("number")) ||
        (feature == featureTypes.teams && touchList.touchesLength() >= getRadioValue("number")) ||
        feature == featureTypes.ordinate
    ) {
        timerTrigger = setTimeout(triggerSelection, triggerTimeout);
    }
};

const triggerSelection = () => {
    clearTimeout(timerTrigger);
    const numbersSelected = getRadioValue("number");
    switch (getFeatureType()) {
        case featureTypes.select :
            touchList.selectPlayers(numbersSelected);
            break;
        case featureTypes.teams :
            touchList.selectTeams(numbersSelected);
            break;
        case featureTypes.ordinate :
            touchList.selectNumbers();
            break;
        default:
            throw new Error("Unrecognised feature type.");
    }

    // if (vibrate) {
    //     window.navigator.vibrate([50, 10, 50]);
    // }

    canvas.removeEventListener("touchstart", handleNewTouch);
    canvas.addEventListener("touchstart", ignoreEvent);
    canvas.removeEventListener("touchend", handleTouchEnd);
    canvas.addEventListener("touchend", handleFinishTouchEnd);
};


const ignoreEvent = e => {
        e.preventDefault();
};

const handleFinishTouchEnd = ev => {
    ev.preventDefault();
    const changedTouches = ev.changedTouches;
    for (let i=0; i < changedTouches.length; ++i) {
        let touch = touchList.getTouch(changedTouches[i].identifier);
        if (touch) {
            touch.isLocked = true;
        }
    }

    if (touchList.areAllTouchesLocked()) {
        resetAllTimeout = setTimeout(resetAll, displayTimeout);
    }
};

const resetAll = () => {
    touchList.empty();

    clearTimeout(timerTrigger);
    clearTimeout(resetAllTimeout);

    canvas.removeEventListener("touchstart", ignoreEvent);
    canvas.removeEventListener("touchmove", ignoreEvent);
    canvas.removeEventListener("touchend", ignoreEvent);
    canvas.removeEventListener("touchend", handleFinishTouchEnd);

    canvas.addEventListener("touchstart", handleNewTouch);
    canvas.addEventListener("touchend", handleTouchEnd);
};

const handleNewTouch = e => {
    e.preventDefault();
    const changedTouches = e.changedTouches;
    for (let i=0; i < changedTouches.length; ++i) {
        touchList.add(changedTouches[i].clientX, changedTouches[i].clientY, changedTouches[i].identifier);
    }
    resetTimerTrigger();
};
const handleTouchEnd = e => {
    e.preventDefault();
    const changedTouches = e.changedTouches;
    for (let i=0; i < changedTouches.length; ++i) {
        touchList.remove(changedTouches[i].identifier);
    }
};
const handleTouchMove = e => {
    e.preventDefault();
    const changedTouches = e.changedTouches;
    for (let i=0; i < changedTouches.length; ++i) {
        touchList.move(changedTouches[i].identifier, changedTouches[i].clientX, changedTouches[i].clientY)
    }
};

const step = () => {
    touchList.update();
    touchList.draw();
    if (touchList.touchesLength() == 0) {
        showMenu();
    }
    else {
        hideMenu();
    }
    window.requestAnimationFrame(step);
};

const resizeCanvas = () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
};

const hideMenu = () => {
    menuContainer.classList.add("transformUp");
    menuContainer.classList.remove("transformBackIn");
    footerContainer.classList.add("transformDown");
    footerContainer.classList.remove("transformBackIn");
};
const showMenu = () => {
    menuContainer.classList.remove("transformUp");
    menuContainer.classList.add("transformBackIn");
    footerContainer.classList.remove("transformDown");
    footerContainer.classList.add("transformBackIn");
};

const start = () => {
    // Properly initialise the radio buttons
    if (optionSelect.checked) {
        showSelect();
    }
    else if (document.getElementById("option-group").checked) {
        showGroup();
    }
    else { //option-ordinate
        showOrdinate();
    }
    // set the events on the radio buttons
    optionSelect.addEventListener("change", () => showSelect());
    document.getElementById("option-group").addEventListener("change", () => showGroup());
    document.getElementById("option-ordinate").addEventListener("change", () => showOrdinate());

    window.addEventListener('resize', resizeCanvas, false);

    canvas.addEventListener("touchstart", handleNewTouch);
    canvas.addEventListener("touchend", handleTouchEnd);
    canvas.addEventListener("touchmove", handleTouchMove);

    resizeCanvas();
    window.requestAnimationFrame(step);
}
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
} else {
    start();
}
        </script>
    </body>
</html>

